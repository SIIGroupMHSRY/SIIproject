<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
 <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
 <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<link rel="stylesheet" type="text/css" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css">
    <link rel="stylesheet" href="libraries/Leaflet.draw/dist/leaflet.draw.css" />
	<link rel="stylesheet" href="libraries/MiniMap/fullscreen.css" />
	<link rel="stylesheet" href="libraries/MiniMap/src/Control.MiniMap.css" />
<!-- HEAD-->
	<link rel="stylesheet" href="libraries/Measure/leaflet.measurecontrol.css" />
	<link rel="stylesheet" href="libraries/L.Control.Sidebar.css" />
	
	<script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
	<script src="libraries/Leaflet.draw/dist/leaflet.draw.js" type="text/javascript"></script>
    <script src="libraries/MiniMap/src/Control.MiniMap.js" type="text/javascript"></script>
	<script src="libraries/Measure/leaflet.measurecontrol.js" type="text/javascript"></script>
	
	<script type='text/javascript' src="libraries/GeometryUtil/dist/leaflet.geometryutil.js"></script>
	<script type='text/javascript' src="libraries/leaflet.almostover.js"></script>
	<script src="libraries/jQuery.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script type="text/javascript" src="libraries/L.Control.Sidebar.js"></script>
<!-- created style sheets and scripts-->
<link href="libraries/bootstrap/css/bootstrap.css" rel="stylesheet">
<script type="text/javascript" src="libraries/L.Control.Sidebar.js"></script>



 <script src="dist/leaflet.awesome-markers.js"></script>
 <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.css" rel="stylesheet">
  <link rel="stylesheet" href="dist/leaflet.awesome-markers.css">


<style>
#map { 
            position: absolute;
            top:0;
            left: 0;
            right: 0;
            bottom:0;
        }
        .leaflet-control.enabled a {
            background-color: yellow;
        }

</style>
<body>

<body style="background-color:#000000">

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
		  <!--<div style="position:absolute;left:30%;top:20%;"><button type="button" onclick="Query()">Query</button></div>-->
		  <a class="navbar-brand" href="index.html">Accomodations</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
			<li onclick="alldata()" class="active"><a href="#">Map</a></li>
            <li onclick="Query()"><a href="#">Query</a></li>
			<li onclick="InvokeMarker()"><a href="#">New Accommodation</a></li>
			
			<li><a href="#">Further links</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

<!-- HEAD-->
<div class="container">
 <div id="map" style="position:absolute;left:25px; top:51px; width: 96%; height: 80%;" >
 
  <div id="AddAccomodationsidebar"> 
	<div id="NewAccomationCoordinates"></div>
  </div>
<!-- QUERY FORMULAR-->
 <div id="sidebar"> 
	<br> <b><font size=4px>Choose the attributes, you want to use for the query:  </b></font>
	<br>
	
	<div style="padding-top:10px">
	<b><font size=3px> size in m<sup>2</sup><b></font>
	</div>
	<div style="border: thin solid #000000; border-bottom-width: 0px;">
	</div>
	<div style="padding-top:10px">
			min. : &nbsp <input type="text" style="width: 70px" id="qsizemin">&nbsp&nbsp&nbsp&nbsp
			max. : &nbsp <input type="text" style="width: 70px" id="qsizemax"> 
	</div>

	<div style="padding-top:15px">
	<b><font size=3px> price in &#8364;</b></font>
	</div>
	<div style="border: thin solid #000000; border-bottom-width: 0px;">
	</div>
	<div style="padding-top:10px">
		min. :&nbsp <input type="text" style="width: 70px" id="qpricemin">&nbsp&nbsp&nbsp&nbsp
		max. :&nbsp <input type="text" style="width: 70px" id="qpricemax"><br>
	</div>
	
	<div style="padding-top:15px">
	<b><font size=3px>type</b></font>
	</div>
	<div style="border: thin solid #000000; border-bottom-width: 0px;">
	</div>
	<div style="padding-top:10px">
		<input type="radio" id="qflat">&nbsp flat &nbsp&nbsp&nbsp&nbsp
		<input type="radio" id="qfsc"> &nbsp flat-sharing-community
	</div>
	
	<div style="padding-top:15px">
	<b><font size=3px>number of fellow lodger</b></font>
	</div>
	<div style="border: thin solid #000000; border-bottom-width: 0px;">
	</div>
	<div style="padding-top:10px">
		min. : &nbsp <input type="text" style="width: 70px" id="qminlodger">  &nbsp&nbsp&nbsp&nbsp
		max. :&nbsp <input type="text" style="width: 70px" id="qmaxlodger">
	</div>

	<div style="padding-top:15px">
	<b><font size=3px>number of rooms</b></font>
	</div>
	<div style="border: thin solid #000000; border-bottom-width: 0px;">
	</div>
	<div style="padding-top:10px">
		 min. : &nbsp <input type="text" style="width: 70px" id="qminroom">&nbsp&nbsp&nbsp&nbsp
		 max. :&nbsp <input type="text" style="width: 70px" id="qmaxroom">
	</div>
	
	<br>
	<div style="padding-top:10px">
		zip code: &nbsp <input type="text" id="qzip">
	</div>
	<br>

	<button type="button" onclick="queryattributes()">Submit</button>
	<button type="button" onclick="queryclear()">Clear</button>
	<br><br>
</div>

</div>
 </div>


<!--<div style="position:absolute; top: 90%;">
<FONT COLOR=WHITE>
<table border='1'>
<tr>
<th>Firstname</th>
<th>Lastname</th>
</tr>
</font>
</div>-->

 
	<script>
//create map
var map = L.map('map').setView([51.9604,7.6197], 14);

//sidebar
var sidebar = L.control.sidebar('sidebar', {
    position: 'right'
});

map.addControl(sidebar);
function ShowSidebar()
{
sidebar.show();
}

var AddAccomodationsidebar = L.control.sidebar('AddAccomodationsidebar', {
    position: 'right'
});

map.addControl(AddAccomodationsidebar);

//

//Adding WFS Layer by JSON Format

	var myLayer = new L.geoJson(null,{
onEachFeature: function 
(feature, layer) 
{

layer.bindPopup("Street:"+feature.properties.Street+
"<br>Rooms:"+feature.properties.rooms
);},


 pointToLayer: function(feature, latlng) {
        return new L.marker(latlng, {icon: L.AwesomeMarkers.icon({icon: 'home', prefix: 'fa', markerColor: 'green', spin:false}) });
		return new L.CircleMarker(latlng, {radius: 10, fillOpacity: 0.85});
    },


 
}).addTo(map);











/*
L.geoJson(geoJson, {
    pointToLayer: function (feature, latlng) {
        return L.marker(latlng, 
            {icon: L.AwesomeMarkers.icon({icon: 'spinner', prefix: 'fa', markerColor: 'red', spin:true})};
    }

	
	}).addTo(map);


*/







function loadGeoJson(data) {
myLayer.addData(data); 
}

var geoJsonUrl ="http://giv-siidemo.uni-muenster.de:8080/geoserver/group10ws/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=group10ws:flats&format=text/javascript&outputFormat=json&format_options=callback:loadGeoJson";
$.ajax({ 
        url: geoJsonUrl, 
        dataType: 'jsonp' 
}); 

function alldata(data){
var geoJsonUrl ="http://giv-siidemo.uni-muenster.de:8080/geoserver/group10ws/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=group10ws:flats&format=text/javascript&outputFormat=json&format_options=callback:loadGeoJson";
$.ajax({ 
        url: geoJsonUrl, 
        dataType: 'jsonp' 
}); 
}


var layer1=L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>'
+' contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>,'
+'Imagery &copy <a href="http://cloudmade.com">CloudMade</a>',
    maxZoom: 18
});

layer1.addTo(map);




		
//OSM maps one as overlay and one base layer 
var osmUrl='http://a.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osmAttrib='Map data &copy; OpenStreetMap contributors';
var layerOSM=L.tileLayer(osmUrl, {minZoom: 0, maxZoom: 18, attribution: osmAttrib});
var layerOSMtransparent=L.tileLayer('http://a.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy<a href="www.openstretmap.org/copyright ">OpenStreetMap</a> contributors',
	opacity:0.5,
    format: 'image/png',
	
});
//Layers of Geobasis NRW: http://www.bezreg-koeln.nrw.de/brk_internet/organisation/abteilung07/produkte/nrwatlas/index.html 
//                          (website which provides different Web Map Service (WMS)-URLs)
var layerDTK10_pan=L.tileLayer.wms('http://www.wms.nrw.de/geobasis/wms_nw_dtk10', {
   attribution: '| &copy Geobasis NRW 2013',
	layers: 'NW_DTK10_pan',
    format: 'image/png',
    transparent: true,
	opacity:0.4	
});
var layerDTK10=L.tileLayer.wms('http://www.wms.nrw.de/geobasis/wms_nw_dtk10', {
     attribution: '| &copy Geobasis NRW 2013',
	layers: 'nw_dtk10_pan,nw_dtk10_res,NW_DTK10_col,WMS_NW_DTK10',
    format: 'image/png',
    transparent: true
});
//layer of the different districts
var layerDVG=L.tileLayer.wms('http://www.wms.nrw.de/geobasis/wms_nw_dvg', {
     attribution: '| &copy Geobasis NRW 2013',
	layers: 'WMS_NW_DVG',
    format: 'image/png',
    transparent: true,
	opacity:0.5
});
var layerDGK5=L.tileLayer.wms('http://www.wms.nrw.de/geobasis/wms_nw_dgk5', {
 attribution: '| &copy Geobasis NRW 2013',
	layers: 'WMS_NW_DGK5',
    format: 'image/png',
    transparent: true,
	opacity:0.5
});
//Orthophoto layer
var layerOrtho = L.tileLayer.wms('http://www.wms.nrw.de/geobasis/wms_nw_dop40', {
    layers: 'WMS_NW_DOP40',
    format: 'image/png',
	version:'1.3.0',
    attribution: '| &copy Geobasis NRW 2013'
});
//The map which is visualized when you get on the website.
layerOSM.addTo(map);

//Map control: Layer switcher
var baseMaps={ "OSM": layerOSM,
               "arial view": layerOrtho,
			   "DTK10":layerDTK10
               };
var overlapMaps={"OSM":layerOSMtransparent,
                  "DVG":layerDVG,
				  "DTK10_pan":layerDTK10_pan,
				  "DGK5":layerDGK5};
var control=L.control.layers(baseMaps,overlapMaps,{position:'bottomleft'}).addTo(map);

//miniMap
	var osm2 = new L.TileLayer(osmUrl, {minZoom: 0, maxZoom: 13, attribution: osmAttrib });
	var miniMap = new L.Control.MiniMap(osm2, { toggleDisplay: true }).addTo(map);

//measure Control 
	L.Control.measureControl().addTo(map);
	
	
//drawing tool
// Initialise the FeatureGroup to store editable layers
var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);
// Set the title to show on the polygon button
		L.drawLocal.draw.toolbar.buttons.marker = 'Add New Accommodation';

// Initialise the draw control and pass it the FeatureGroup of editable layers
var drawControl = new L.Control.Draw({
    
	draw: {
			polyline: false,
			polygon:false,
			rectangle:false,
			circle:false
			},
	
	edit: {
        featureGroup: drawnItems
    }
});
map.addControl(drawControl);

map.on('draw:created', function (e) {
    var type = e.layerType,
        layer = e.layer;

    if (type === 'marker') {
        // Do marker specific actions
		var coordinates = layer.toGeoJSON().geometry.coordinates;
				var coord=coordinates.toString();
				AddAccomod(coord);
    }

    // Do whatever else you need to. (save to db, add to map etc)
    map.addLayer(layer);
});


	
//getlocation
map.locate({setView: true, maxZoom: 16});

function onLocationFound(e) {
    var radius = e.accuracy / 2;

    L.marker(e.latlng,{icon: L.AwesomeMarkers.icon({icon: 'spinner', prefix: 'fa', markerColor: 'red', spin:true}) }).addTo(map)
        .bindPopup("You are within " + radius + " meters from this point. Do you want to start a query with this location?").openPopup();

    L.circle(e.latlng, radius).addTo(map);
}

map.on('locationfound', onLocationFound);

function onLocationError(e) {
    alert(e.message);
}

function initialvariables(){
	qsizemin=-1;
	qsizemax=-1;
	qpricemin=-1;
	qpricemax=-1;
	qflats=-1;
	gfsc=-1;
	qmaxlodger=-1;
	qminlodger=-1;
	qmaxroom=-1;
	qminroom=-1;
	qzip=-1;
}

function Query(){
	queryclear()
	sidebar.show();	
}

function queryattributes(){
	qsizemin=document.getElementById('qsizemin').value;
	qsizemax=document.getElementById('qsizemax').value;
	qpricemin=document.getElementById('qpricemin').value;
	qpricemax=document.getElementById('qpricemax').value;
	if (document.getElementById('qflat').checked==true)
		qflats=1;
	if (document.getElementById('qfsc').checked==true)
		gfsc=1;
	qmaxlodger=document.getElementById('qmaxlodger').value;
	qminlodger=document.getElementById('qminlodger').value;
	qmaxroom=document.getElementById('qmaxroom').value;
	qminroom=document.getElementById('qminroom').value;
	qzip=document.getElementById('qzip').value;
	
	var geoJsonquery ="http://giv-siidemo.uni-muenster.de:8080/geoserver/group10ws/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=group10ws:flats&Filter=<Filter><And>"
	if (qsizemin != ''){
	geoJsonquery +="<PropertyIsGreaterThanOrEqualTo><PropertyName>area</PropertyName><Literal>"
	geoJsonquery +=qsizemin
	geoJsonquery +="</Literal></PropertyIsGreaterThanOrEqualTo>"
	}
	
	if (qsizemax != ''){
	geoJsonquery +="<PropertyIsLessThanOrEqualTo><PropertyName>area</PropertyName><Literal>"
	geoJsonquery +=qsizemax
	geoJsonquery +="</Literal></PropertyIsLessThanOrEqualTo>"
	}
	
	if (qpricemin != ''){
	geoJsonquery +="<PropertyIsGreaterThanOrEqualTo><PropertyName>price</PropertyName><Literal>"
	geoJsonquery +=qpricemin
	geoJsonquery +="</Literal></PropertyIsGreaterThanOrEqualTo>"
	}
	
	if (qpricemax != ''){
	geoJsonquery +="<PropertyIsLessThanOrEqualTo><PropertyName>price</PropertyName><Literal>"
	geoJsonquery +=qpricemax
	geoJsonquery +="</Literal></PropertyIsLessThanOrEqualTo>"
	}
	
	//if (qflats == 1){
	//geoJsonquery +="<PropertyIsEqualTo><PropertyName>price</PropertyName><Literal>"
	//geoJsonquery +=qpricemax
	//geoJsonquery +="</Literal></PropertyIsEqualTo>"
	//}
	
	//if (qfsc == 1){
	//geoJsonquery +="<PropertyIsEqualTo><PropertyName>price</PropertyName><Literal>"
	//geoJsonquery +=qpricemax
	//geoJsonquery +="</Literal></PropertyIsEqualTo>"
	//}
	
	//if (qmaxlodger != ''){
	//geoJsonquery +="<PropertyIsLessThanOrEqualTo><PropertyName>price</PropertyName><Literal>"
	//geoJsonquery +=qpricemax
	//geoJsonquery +="</Literal></PropertyIsLessThanOrEqualTo>"
	//}
	
	//if (qminlodger != ''){
	//geoJsonquery +="<PropertyIsLessThanOrEqualTo><PropertyName>price</PropertyName><Literal>"
	//geoJsonquery +=qpricemax
	//geoJsonquery +="</Literal></PropertyIsLessThanOrEqualTo>"
	//}
	
	if(qminroom != ''){
	geoJsonquery +="<PropertyIsGreaterThanOrEqualTo><PropertyName>rooms</PropertyName><Literal>"
	geoJsonquery +=qminroom
	geoJsonquery +="</Literal></PropertyIsGreaterThanOrEqualTo>"
	}
	
	if(qmaxroom != ''){
	geoJsonquery +="<PropertyIsLessThanOrEqualTo><PropertyName>rooms</PropertyName><Literal>"
	geoJsonquery +=qmaxroom
	geoJsonquery +="</Literal></PropertyIsLessThanOrEqualTo>"
	}
	
	if(qzip != ''){
	geoJsonquery +="<PropertyIsEqualTo><PropertyName>zip</PropertyName><Literal>"
	geoJsonquery +=qzip
	geoJsonquery +="</Literal></PropertyIsGreaterThanOrEqualTo>"
	}
	
	geoJsonquery +="</And></Filter>&format=text/javascript&outputFormat=json&format_options=callback:loadGeoJsonQuery";
	
	$.ajax({ 
        url: geoJsonquery, 
        dataType: 'jsonp' 
}); 
}

function loadGeoJsonQuery(data) {
myLayer.clearLayers();
myLayer.addData(data);
}

function queryclear(){
	document.getElementById('qsizemin').value='';
	document.getElementById('qsizemax').value='';
	document.getElementById('qpricemin').value='';
	document.getElementById('qpricemax').value='';
	document.getElementById('qflat').checked=false;
	document.getElementById('qfsc').checked=false;
	document.getElementById('qmaxlodger').value='';
	document.getElementById('qminlodger').value='';
	document.getElementById('qmaxroom').value='';
	document.getElementById('qminroom').value='';
	document.getElementById('qzip').value='';
	
	initialvariables()
}

map.on('locationerror', onLocationError);

//-----------------------
function AddAccomod(Coord){
	AddAccomodationsidebar.show();
	$.get( "AddNewAccomodation.php?Coord="+Coord, function( data ) {
	document.getElementById('NewAccomationCoordinates').innerHTML = data;
	});
}
function InvokeMarker(Coord){
	new L.Draw.Marker(map, drawControl.options.marker).enable( )// to invoke draw Marker command 
}
//-------------------------




 L.marker([51.960133,7.607246], {icon: L.AwesomeMarkers.icon({icon: 'spinner', prefix: 'fa', markerColor: 'red', spin:true}) }).addTo(map);





	</script>
</div>
</div>
	</body>
	</html>